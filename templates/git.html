<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustAI - Git Visualizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-elevated: #242430;
            --border-color: #2a2a3a;
            --border-light: #3a3a4a;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a0;
            --text-muted: #606070;
            --accent-primary: #6366f1;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.15);
            padding: 6px 10px;
            border-radius: 6px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-success);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            color: white;
        }

        /* Main Layout */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Commands Panel */
        .commands-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .commands-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .command-group {
            margin-bottom: 20px;
        }

        .command-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 8px;
            margin-bottom: 8px;
        }

        .command-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            margin-bottom: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
        }

        .command-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-light);
            transform: translateX(4px);
        }

        .command-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .command-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 14px;
            flex-shrink: 0;
        }

        .command-info h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .command-info p {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Visualization Area */
        .visualization-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viz-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .branch-tabs {
            display: flex;
            gap: 8px;
        }

        .branch-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .branch-tab:hover {
            background: var(--bg-elevated);
        }

        .branch-tab.active {
            background: var(--accent-success);
            border-color: var(--accent-success);
            color: white;
        }

        .branch-tab .branch-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .viz-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background:
                radial-gradient(circle at 1px 1px, var(--border-color) 1px, transparent 0);
            background-size: 24px 24px;
        }

        .git-graph {
            position: relative;
            min-height: 100%;
            padding: 40px;
        }

        /* Commit Nodes */
        .commit-node {
            position: absolute;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .commit-node:hover {
            transform: scale(1.15);
            z-index: 20;
        }

        .commit-node.selected {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.5);
        }

        .commit-node.main { background: var(--accent-success); }
        .commit-node.feature { background: var(--accent-purple); }
        .commit-node.hotfix { background: var(--accent-error); }
        .commit-node.develop { background: var(--accent-blue); }

        .commit-label {
            position: absolute;
            top: 56px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .commit-hash {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Branch Lines */
        .branch-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .branch-line {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
        }

        /* Head Pointer */
        .head-pointer {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--accent-primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            z-index: 15;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .head-pointer::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--accent-primary);
        }

        /* Info Panel */
        .info-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .info-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-section h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .commit-details {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
        }

        .commit-details-hash {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .commit-details-message {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .commit-details-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Terminal */
        .terminal-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .terminal {
            flex: 1;
            background: #0d1117;
            border-radius: 8px;
            margin: 0 20px 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #161b22;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-body {
            flex: 1;
            padding: 12px 14px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .terminal-line {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .terminal-line.command {
            color: var(--accent-success);
        }

        .terminal-line.output {
            color: var(--text-secondary);
        }

        .terminal-line.error {
            color: var(--accent-error);
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .terminal-prompt {
            color: var(--accent-success);
        }

        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: inherit;
            outline: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Placeholder */
        .placeholder-text {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <a href="/" class="logo">
                <span class="logo-icon">&lt;/&gt;</span>
                <span class="logo-text">TrustAI</span>
            </a>
            <div class="header-actions">
                <button class="btn btn-secondary" id="resetBtn">Reset</button>
                <button class="btn btn-secondary" id="tutorialBtn">Tutorial</button>
                <a href="/" class="btn btn-secondary">‚Üê Home</a>
            </div>
        </header>

        <main class="main-content">
            <!-- Commands Panel -->
            <aside class="commands-panel">
                <div class="panel-header">
                    <h2>Git Commands</h2>
                </div>
                <div class="commands-list">
                    <div class="command-group">
                        <div class="command-group-title">Basic</div>
                        <button class="command-btn" data-command="commit">
                            <div class="command-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--accent-success);">+</div>
                            <div class="command-info">
                                <h4>Commit</h4>
                                <p>Save your changes</p>
                            </div>
                        </button>
                    </div>

                    <div class="command-group">
                        <div class="command-group-title">Branches</div>
                        <button class="command-btn" data-command="branch">
                            <div class="command-icon" style="background: rgba(139, 92, 246, 0.2); color: var(--accent-purple);">üåø</div>
                            <div class="command-info">
                                <h4>New Branch</h4>
                                <p>Create a branch</p>
                            </div>
                        </button>
                        <button class="command-btn" data-command="checkout">
                            <div class="command-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--accent-blue);">‚Ü©</div>
                            <div class="command-info">
                                <h4>Checkout</h4>
                                <p>Switch branches</p>
                            </div>
                        </button>
                        <button class="command-btn" data-command="merge">
                            <div class="command-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--accent-warning);">üîÄ</div>
                            <div class="command-info">
                                <h4>Merge</h4>
                                <p>Combine branches</p>
                            </div>
                        </button>
                    </div>

                    <div class="command-group">
                        <div class="command-group-title">Remote</div>
                        <button class="command-btn" data-command="push">
                            <div class="command-icon" style="background: rgba(236, 72, 153, 0.2); color: var(--accent-pink);">‚¨Ü</div>
                            <div class="command-info">
                                <h4>Push</h4>
                                <p>Upload to remote</p>
                            </div>
                        </button>
                        <button class="command-btn" data-command="pull">
                            <div class="command-icon" style="background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan);">‚¨á</div>
                            <div class="command-info">
                                <h4>Pull</h4>
                                <p>Download changes</p>
                            </div>
                        </button>
                    </div>

                    <div class="command-group">
                        <div class="command-group-title">History</div>
                        <button class="command-btn" data-command="revert">
                            <div class="command-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--accent-error);">‚Ü∂</div>
                            <div class="command-info">
                                <h4>Revert</h4>
                                <p>Undo a commit</p>
                            </div>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Visualization Area -->
            <section class="visualization-area">
                <div class="viz-header">
                    <div class="branch-tabs" id="branchTabs">
                        <!-- Dynamically populated -->
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted);">
                        Click commands to interact ‚Ä¢ Drag commits to reorder
                    </div>
                </div>
                <div class="viz-canvas">
                    <svg class="branch-lines" id="branchLines"></svg>
                    <div class="git-graph" id="gitGraph">
                        <!-- Commits rendered here -->
                    </div>
                </div>
            </section>

            <!-- Info Panel -->
            <aside class="info-panel">
                <div class="info-section">
                    <h3>Selected Commit</h3>
                    <div class="commit-details" id="commitDetails">
                        <div class="placeholder-text">Click a commit to see details</div>
                    </div>
                </div>

                <div class="info-section terminal-section">
                    <h3>Terminal</h3>
                    <div class="terminal">
                        <div class="terminal-header">
                            <div class="terminal-dot red"></div>
                            <div class="terminal-dot yellow"></div>
                            <div class="terminal-dot green"></div>
                        </div>
                        <div class="terminal-body" id="terminalBody">
                            <div class="terminal-line output">Welcome to Git Visualizer!</div>
                            <div class="terminal-line output">Use the commands on the left or type below.</div>
                        </div>
                        <div class="terminal-input-line" style="padding: 0 14px 12px;">
                            <span class="terminal-prompt">$</span>
                            <input type="text" class="terminal-input" id="terminalInput" placeholder="git commit -m 'message'">
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="commitModal">
        <div class="modal">
            <h3>Create Commit</h3>
            <input type="text" class="modal-input" id="commitMessage" placeholder="Enter commit message...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('commitModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCommit()">Commit</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="branchModal">
        <div class="modal">
            <h3>Create Branch</h3>
            <input type="text" class="modal-input" id="branchName" placeholder="Enter branch name...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('branchModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmBranch()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="checkoutModal">
        <div class="modal">
            <h3>Checkout Branch</h3>
            <select class="modal-input" id="checkoutSelect">
                <!-- Populated dynamically -->
            </select>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('checkoutModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCheckout()">Checkout</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mergeModal">
        <div class="modal">
            <h3>Merge Branch</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                Select branch to merge into <strong id="currentBranchName"></strong>:
            </p>
            <select class="modal-input" id="mergeSelect">
                <!-- Populated dynamically -->
            </select>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('mergeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmMerge()">Merge</button>
            </div>
        </div>
    </div>

    <script>
        class GitVisualizer {
            constructor() {
                this.commits = [];
                this.branches = {
                    'main': { color: 'var(--accent-success)', commits: [], head: null }
                };
                this.currentBranch = 'main';
                this.headCommit = null;
                this.selectedCommit = null;
                this.commitCounter = 0;

                this.init();
            }

            init() {
                this.setupCommands();
                this.setupTerminal();
                this.setupReset();

                // Create initial commit
                this.createCommit('Initial commit', 'main');

                this.render();
            }

            setupCommands() {
                document.querySelectorAll('.command-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const command = btn.dataset.command;
                        this.handleCommand(command);
                    });
                });
            }

            setupTerminal() {
                const input = document.getElementById('terminalInput');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.executeTerminalCommand(input.value);
                        input.value = '';
                    }
                });
            }

            setupReset() {
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.reset();
                });

                document.getElementById('tutorialBtn').addEventListener('click', () => {
                    this.runTutorial();
                });
            }

            handleCommand(command) {
                switch (command) {
                    case 'commit':
                        this.showModal('commitModal');
                        break;
                    case 'branch':
                        this.showModal('branchModal');
                        break;
                    case 'checkout':
                        this.populateCheckoutModal();
                        this.showModal('checkoutModal');
                        break;
                    case 'merge':
                        this.populateMergeModal();
                        this.showModal('mergeModal');
                        break;
                    case 'push':
                        this.push();
                        break;
                    case 'pull':
                        this.pull();
                        break;
                    case 'revert':
                        this.revert();
                        break;
                }
            }

            generateHash() {
                return Math.random().toString(16).substr(2, 7);
            }

            createCommit(message, branch = this.currentBranch) {
                const hash = this.generateHash();
                const commit = {
                    id: this.commitCounter++,
                    hash,
                    message,
                    branch,
                    parent: this.branches[branch].head,
                    timestamp: new Date().toISOString(),
                    author: 'You'
                };

                this.commits.push(commit);
                this.branches[branch].commits.push(commit);
                this.branches[branch].head = commit.id;

                if (branch === this.currentBranch) {
                    this.headCommit = commit.id;
                }

                this.addTerminalLine(`git commit -m "${message}"`, 'command');
                this.addTerminalLine(`[${branch} ${hash}] ${message}`, 'output');

                this.render();
                return commit;
            }

            createBranch(name) {
                if (this.branches[name]) {
                    this.addTerminalLine(`git branch ${name}`, 'command');
                    this.addTerminalLine(`fatal: A branch named '${name}' already exists.`, 'error');
                    return;
                }

                const colors = ['var(--accent-purple)', 'var(--accent-blue)', 'var(--accent-pink)', 'var(--accent-cyan)', 'var(--accent-warning)'];
                const colorIndex = Object.keys(this.branches).length % colors.length;

                this.branches[name] = {
                    color: colors[colorIndex],
                    commits: [...this.branches[this.currentBranch].commits],
                    head: this.branches[this.currentBranch].head,
                    parent: this.currentBranch,
                    branchPoint: this.branches[this.currentBranch].head
                };

                this.addTerminalLine(`git branch ${name}`, 'command');
                this.addTerminalLine(`Created branch '${name}'`, 'output');

                this.render();
            }

            checkout(branch) {
                if (!this.branches[branch]) {
                    this.addTerminalLine(`git checkout ${branch}`, 'command');
                    this.addTerminalLine(`error: pathspec '${branch}' did not match any file(s)`, 'error');
                    return;
                }

                this.currentBranch = branch;
                this.headCommit = this.branches[branch].head;

                this.addTerminalLine(`git checkout ${branch}`, 'command');
                this.addTerminalLine(`Switched to branch '${branch}'`, 'output');

                this.render();
            }

            merge(sourceBranch) {
                if (!this.branches[sourceBranch]) {
                    this.addTerminalLine(`git merge ${sourceBranch}`, 'command');
                    this.addTerminalLine(`merge: ${sourceBranch} - not something we can merge`, 'error');
                    return;
                }

                const sourceHead = this.branches[sourceBranch].head;
                const targetHead = this.branches[this.currentBranch].head;

                // Create merge commit
                const hash = this.generateHash();
                const commit = {
                    id: this.commitCounter++,
                    hash,
                    message: `Merge branch '${sourceBranch}' into ${this.currentBranch}`,
                    branch: this.currentBranch,
                    parent: targetHead,
                    mergeParent: sourceHead,
                    timestamp: new Date().toISOString(),
                    author: 'You',
                    isMerge: true
                };

                this.commits.push(commit);
                this.branches[this.currentBranch].commits.push(commit);
                this.branches[this.currentBranch].head = commit.id;
                this.headCommit = commit.id;

                this.addTerminalLine(`git merge ${sourceBranch}`, 'command');
                this.addTerminalLine(`Merge made by the 'recursive' strategy.`, 'output');

                this.render();
            }

            push() {
                this.addTerminalLine(`git push origin ${this.currentBranch}`, 'command');
                this.addTerminalLine(`Enumerating objects: ${this.branches[this.currentBranch].commits.length}, done.`, 'output');
                this.addTerminalLine(`To github.com:user/repo.git`, 'output');
                this.addTerminalLine(`   ${this.generateHash()}..${this.branches[this.currentBranch].head !== null ? this.commits[this.branches[this.currentBranch].head].hash : 'HEAD'}  ${this.currentBranch} -> ${this.currentBranch}`, 'output');
            }

            pull() {
                this.addTerminalLine(`git pull origin ${this.currentBranch}`, 'command');
                this.addTerminalLine(`Already up to date.`, 'output');
            }

            revert() {
                if (this.branches[this.currentBranch].commits.length <= 1) {
                    this.addTerminalLine('git revert HEAD', 'command');
                    this.addTerminalLine('Nothing to revert.', 'error');
                    return;
                }

                const lastCommit = this.commits[this.branches[this.currentBranch].head];
                this.createCommit(`Revert "${lastCommit.message}"`);
            }

            populateCheckoutModal() {
                const select = document.getElementById('checkoutSelect');
                select.innerHTML = '';
                Object.keys(this.branches).forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch + (branch === this.currentBranch ? ' (current)' : '');
                    select.appendChild(option);
                });
            }

            populateMergeModal() {
                document.getElementById('currentBranchName').textContent = this.currentBranch;
                const select = document.getElementById('mergeSelect');
                select.innerHTML = '';
                Object.keys(this.branches).forEach(branch => {
                    if (branch !== this.currentBranch) {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        select.appendChild(option);
                    }
                });
            }

            showModal(id) {
                document.getElementById(id).classList.add('active');
                const input = document.getElementById(id).querySelector('input, select');
                if (input) setTimeout(() => input.focus(), 100);
            }

            addTerminalLine(text, type = 'output') {
                const terminal = document.getElementById('terminalBody');
                const line = document.createElement('div');
                line.className = `terminal-line ${type}`;
                line.textContent = type === 'command' ? `$ ${text}` : text;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }

            executeTerminalCommand(input) {
                const parts = input.trim().split(' ');
                if (parts[0] !== 'git') {
                    this.addTerminalLine(input, 'command');
                    this.addTerminalLine(`command not found: ${parts[0]}`, 'error');
                    return;
                }

                const cmd = parts[1];
                switch (cmd) {
                    case 'commit':
                        if (parts[2] === '-m' && parts[3]) {
                            const message = parts.slice(3).join(' ').replace(/['"]/g, '');
                            this.createCommit(message);
                        } else {
                            this.showModal('commitModal');
                        }
                        break;
                    case 'branch':
                        if (parts[2]) {
                            this.createBranch(parts[2]);
                        } else {
                            this.addTerminalLine(input, 'command');
                            Object.keys(this.branches).forEach(b => {
                                this.addTerminalLine(`${b === this.currentBranch ? '* ' : '  '}${b}`, 'output');
                            });
                        }
                        break;
                    case 'checkout':
                        if (parts[2] === '-b' && parts[3]) {
                            this.createBranch(parts[3]);
                            this.checkout(parts[3]);
                        } else if (parts[2]) {
                            this.checkout(parts[2]);
                        }
                        break;
                    case 'merge':
                        if (parts[2]) {
                            this.merge(parts[2]);
                        }
                        break;
                    case 'push':
                        this.push();
                        break;
                    case 'pull':
                        this.pull();
                        break;
                    case 'log':
                        this.addTerminalLine(input, 'command');
                        this.branches[this.currentBranch].commits.slice(-5).reverse().forEach(c => {
                            const commit = this.commits[c.id || c];
                            if (commit) {
                                this.addTerminalLine(`commit ${commit.hash}`, 'output');
                                this.addTerminalLine(`    ${commit.message}`, 'output');
                            }
                        });
                        break;
                    default:
                        this.addTerminalLine(input, 'command');
                        this.addTerminalLine(`git: '${cmd}' is not a git command.`, 'error');
                }
            }

            selectCommit(commit) {
                this.selectedCommit = commit;
                const details = document.getElementById('commitDetails');
                details.innerHTML = `
                    <div class="commit-details-hash">${commit.hash}</div>
                    <div class="commit-details-message">${commit.message}</div>
                    <div class="commit-details-meta">
                        <span>Author: ${commit.author}</span>
                        <span>Branch: ${commit.branch}</span>
                        <span>Date: ${new Date(commit.timestamp).toLocaleString()}</span>
                    </div>
                `;
                this.render();
            }

            render() {
                this.renderBranchTabs();
                this.renderGraph();
            }

            renderBranchTabs() {
                const tabs = document.getElementById('branchTabs');
                tabs.innerHTML = '';

                Object.entries(this.branches).forEach(([name, branch]) => {
                    const tab = document.createElement('div');
                    tab.className = `branch-tab ${name === this.currentBranch ? 'active' : ''}`;
                    tab.innerHTML = `
                        <span class="branch-dot" style="background: ${branch.color}"></span>
                        ${name}
                    `;
                    tab.addEventListener('click', () => this.checkout(name));
                    tabs.appendChild(tab);
                });
            }

            renderGraph() {
                const graph = document.getElementById('gitGraph');
                const svg = document.getElementById('branchLines');
                graph.innerHTML = '';
                svg.innerHTML = '';

                const branchNames = Object.keys(this.branches);
                const branchY = {};
                branchNames.forEach((name, i) => {
                    branchY[name] = 80 + i * 100;
                });

                // Calculate positions
                const positions = {};
                let maxX = 0;

                this.commits.forEach((commit, index) => {
                    const x = 80 + index * 120;
                    const y = branchY[commit.branch] || 80;
                    positions[commit.id] = { x, y };
                    maxX = Math.max(maxX, x);
                });

                // Draw branch lines
                Object.entries(this.branches).forEach(([name, branch]) => {
                    const branchCommits = branch.commits.map(c => typeof c === 'object' ? c : this.commits.find(cm => cm.id === c)).filter(Boolean);

                    for (let i = 1; i < branchCommits.length; i++) {
                        const from = positions[branchCommits[i - 1].id];
                        const to = positions[branchCommits[i].id];

                        if (from && to) {
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                            if (branchCommits[i].isMerge && branchCommits[i].mergeParent !== undefined) {
                                // Normal line
                                path.setAttribute('d', `M ${from.x + 24} ${from.y + 24} L ${to.x + 24} ${to.y + 24}`);
                            } else if (from.y !== to.y) {
                                // Curved line for branch
                                const midX = (from.x + to.x) / 2;
                                path.setAttribute('d', `M ${from.x + 24} ${from.y + 24} C ${midX} ${from.y + 24}, ${midX} ${to.y + 24}, ${to.x + 24} ${to.y + 24}`);
                            } else {
                                path.setAttribute('d', `M ${from.x + 24} ${from.y + 24} L ${to.x + 24} ${to.y + 24}`);
                            }

                            path.classList.add('branch-line');
                            path.style.stroke = branch.color;
                            svg.appendChild(path);
                        }
                    }

                    // Draw merge lines
                    branchCommits.forEach(commit => {
                        if (commit.isMerge && commit.mergeParent !== undefined) {
                            const from = positions[commit.mergeParent];
                            const to = positions[commit.id];
                            if (from && to) {
                                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                const midX = (from.x + to.x) / 2;
                                path.setAttribute('d', `M ${from.x + 24} ${from.y + 24} C ${midX} ${from.y + 24}, ${midX} ${to.y + 24}, ${to.x + 24} ${to.y + 24}`);
                                path.classList.add('branch-line');
                                path.style.stroke = this.branches[this.commits[commit.mergeParent]?.branch]?.color || branch.color;
                                path.style.strokeDasharray = '5,5';
                                svg.appendChild(path);
                            }
                        }
                    });
                });

                // Draw commit nodes
                this.commits.forEach(commit => {
                    const pos = positions[commit.id];
                    if (!pos) return;

                    const node = document.createElement('div');
                    node.className = `commit-node ${commit.branch}`;
                    node.style.left = pos.x + 'px';
                    node.style.top = pos.y + 'px';
                    node.style.background = this.branches[commit.branch]?.color || 'var(--accent-success)';
                    node.innerHTML = commit.isMerge ? 'üîÄ' : '‚óè';

                    if (this.selectedCommit && this.selectedCommit.id === commit.id) {
                        node.classList.add('selected');
                    }

                    node.addEventListener('click', () => this.selectCommit(commit));

                    // Label
                    const label = document.createElement('div');
                    label.className = 'commit-label';
                    label.textContent = commit.message.substring(0, 20) + (commit.message.length > 20 ? '...' : '');
                    node.appendChild(label);

                    // Hash
                    const hash = document.createElement('div');
                    hash.className = 'commit-hash';
                    hash.textContent = commit.hash;
                    node.appendChild(hash);

                    graph.appendChild(node);
                });

                // HEAD pointer
                if (this.headCommit !== null && positions[this.headCommit]) {
                    const headPos = positions[this.headCommit];
                    const pointer = document.createElement('div');
                    pointer.className = 'head-pointer';
                    pointer.style.left = (headPos.x + 60) + 'px';
                    pointer.style.top = (headPos.y + 12) + 'px';
                    pointer.textContent = `HEAD ‚Üí ${this.currentBranch}`;
                    graph.appendChild(pointer);
                }

                // Set graph size
                graph.style.minWidth = (maxX + 200) + 'px';
                graph.style.minHeight = (80 + branchNames.length * 100 + 100) + 'px';
            }

            reset() {
                this.commits = [];
                this.branches = {
                    'main': { color: 'var(--accent-success)', commits: [], head: null }
                };
                this.currentBranch = 'main';
                this.headCommit = null;
                this.selectedCommit = null;
                this.commitCounter = 0;

                document.getElementById('terminalBody').innerHTML = `
                    <div class="terminal-line output">Repository reset!</div>
                `;

                this.createCommit('Initial commit', 'main');
                this.render();
            }

            async runTutorial() {
                this.reset();
                await this.sleep(500);

                // Step 1: Create commits on main
                this.addTerminalLine('--- Tutorial: Learning Git Branching ---', 'output');
                await this.sleep(1000);

                this.createCommit('Add README.md');
                await this.sleep(800);

                this.createCommit('Add index.html');
                await this.sleep(800);

                // Step 2: Create a feature branch
                this.createBranch('feature');
                await this.sleep(500);
                this.checkout('feature');
                await this.sleep(800);

                // Step 3: Make commits on feature
                this.createCommit('Add login form');
                await this.sleep(800);

                this.createCommit('Add validation');
                await this.sleep(800);

                // Step 4: Switch back to main
                this.checkout('main');
                await this.sleep(800);

                this.createCommit('Fix typo in README');
                await this.sleep(800);

                // Step 5: Merge
                this.merge('feature');
                await this.sleep(500);

                this.addTerminalLine('', 'output');
                this.addTerminalLine('üéâ Tutorial complete! Try the commands yourself.', 'output');
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Modal functions
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function confirmCommit() {
            const message = document.getElementById('commitMessage').value.trim();
            if (message) {
                window.gitViz.createCommit(message);
                document.getElementById('commitMessage').value = '';
                closeModal('commitModal');
            }
        }

        function confirmBranch() {
            const name = document.getElementById('branchName').value.trim();
            if (name) {
                window.gitViz.createBranch(name);
                document.getElementById('branchName').value = '';
                closeModal('branchModal');
            }
        }

        function confirmCheckout() {
            const branch = document.getElementById('checkoutSelect').value;
            window.gitViz.checkout(branch);
            closeModal('checkoutModal');
        }

        function confirmMerge() {
            const branch = document.getElementById('mergeSelect').value;
            if (branch) {
                window.gitViz.merge(branch);
                closeModal('mergeModal');
            }
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            window.gitViz = new GitVisualizer();
        });
    </script>
</body>
</html>
